# Сервис проведения тендеров
## Задача: 
Написать микросервис, который позволит бизнесу создать тендер на оказание каких-либо услуг. А пользователи/другие бизнесы будут предлагать свои выгодные условия для получения данного тендера.

# Дисклеймер перед началом:
- Честно, во многих моментах во время написания микросервиса замечал запутанность ТЗ. Некоторые данные расходятся, я ниже в бизнес логике написал как я вижу этот проект на основе того, что было написано в ТЗ, но недоговорено.
- К примеру в файле .yml тип айдишника кого угодно, начиная от пользователя, заканчивая организацией написано в формате `string`, а в самом ТЗ написано в `INTEGER`. Из этих двух штук я выбрал `INT`, надеюсь на понимание. Также в некоторых местах непонятно как пишется Предложение. Тут я подумал и решил что лучше будет если у нас будет тип автора, это может быть как Человек, так и Организация в целом. Далее тут тоже не особо понятно становится. Если у нас человек составлял предложение, то изменять может только он или вся организация, в которой он состоит? (я поставил, что только он). Ну а с организацией понятно все: если человек состоит в ней, то он может менять предложение. А также еще одна штука на подумать была про систему статусов предложения. По сути их 5, но за основу я взял 3: Опубликованно это когда предложение принято организацией, отменено это когда все плохо и либо отвергли предложение, либо просто организация отвечающая за предложение передумала. А создано - предложение находится в подвешенном состоянии и по сути оно активно. В общем и целом проект очень понравилось разрабатывать, жду оценки проделанной работы. 

# Стек
- Postgres
- GOlang, включая библиотеки `gorilla/mux` , `gorm.io/gorm`
- Docker
- Swagger

### Бизнес-логика

- У нас есть некий тендер. Его создать может только существующий пользователь, который является членом какой-либо организации. Если тендер в статусе `PUBLISHED` - его видят люди из других организаций.
- Люди из других организация пишут некоторые предложения, которые рассматривают члены организации которая выпустила тендер.
- Если 3 людям из организации где был создан тендер предложение понравилось - они поставили статус "Approved" - предложение принимается.
- Тем самым переводится статус тендера в состояние - `CLOSE`, а остальные предложения, которые не были приняты - переводятся в статус `CANCELED`.
- Статус `CANCELED` можно еще и другими способами, например организация которая предложила что-то передумала, или один из сотрудников, где был создан тендер проголосовал за это предложение статусом `Rejected`. 
- Помимо этого, ответственные за тендер могут менять ее версию, меняя поля запроса. Однако стоит учесть, что из статуса `CLOSED` уже нельзя ничего отредактировать.
- Похожая история с предложениями. В предложении, если оно находится в статусе `PUBLISHED` или `CANCELED`, то в нем нельзя изменить версию, что логично.
- Также из некоторых логичных условий стоит отметить, что предложение на предложение со статусом `CREATED` или `CLOSED` нельзя изменить на `PUBLISHED`, (менять статус предложения вручную может автор предложения и если он сделает статус `PUBLISHED`, то предложение будет принято, все остальные предложения уйдут в статус `CANCELED`, а тендер закроется). Помимо этого, представителям тендера можно оставлять отзывы на предложения, которые им поступают. Также у них есть возможность смотреть отзывы пользователя, который присылаем им предложения, чтобы сделать выводы относительно работы с другими тендерами и принять взвешенное решение.  
- Проработаны всевозможные ошибки, которые могут возникать в процессе выполнения и тестирования приложения. Статусы корректно передаются либо через URL, либо через Swagger (что намного удобнее URL). 
- Ниже представлено описание Тендера и Предложения с описанием использования "ручек".
- В папке "Cкриншоты" показано как работает приложение (если какие-то методы не добавил в скрины, пропустил случайно их), со всеми возможными исходами. 

#### Тендер


Доступные действия с тендером (доступны только создателю тендера или членам его организации):

- **Создание**:

- Тендер будет создан.

- Доступен только ответственным за организацию.
- В таком состоянии нельзя будет создать предложение для него.

- Статус: `CREATED`.

- **Публикация**:
- Состояние, при котором можно будет создать предложение.

- Тендер становится доступен всем пользователям.

- Статус: `PUBLISHED`.

- **Закрытие**:

- Тендер больше не доступен пользователям, кроме ответственных за организацию, но про предложения для него можно будет дальше читать.
- Закрыт может быть по двум причинам: было выбрано предложение, которое понравилось и оно было согласовано;
- ответственные за организацию отключили тендер с помощью 
 :`PUT /api/tenders/{tenderId}/status?status=closed&username=user1`

- Статус: `CLOSED`.

- **Редактирование**:

- Изменяются характеристики тендера.
- По сути меняются поля: `name`, `discription`, `serviceType`, Если значение какого либо из полей не будет передано - оно автоматически останется неизменным.
- Увеличивается версия (то есть, если была 5 версия и мы хотим откатиться ко 2, актуальной станет 6 версия с параметрами 2 версии.

#### Предложение

Предложения могут создавать пользователи от имени своей организации `AuthorType=Organization` и тогда изменения будут доступны всем членам этой организации, а может поступить от человека `AuthorType=User`, тогда вся ответственность на предложение ложится на него.

Предложение связано только с одним тендером. Один пользователь может быть ответственным в одной организации.

Доступные действия с предложениями (могут работать как и автор предложения, члены организации автора, а также организаторы тендера):

- **Создание**:

- Предложение будет создано. Это основной статус предложения, которое будет активно к изменениям, до тех пор, пока не изменится на любой другой статус.

- Доступно только автору и ответственным за организацию.

- Во время этого статуса, сами организаторы и создатели предложения могут поменять статус на `CANCELED`, тем самым передумав и отказаться от своего предложения. А вот создатели тендера (ответственные за организацию, где был создан тендер), куда присылается данное предложение в данном статусе могут отправить либо `REJECTED`, что сразу же переводит статус предложения в состояние `CANCELED`, либо отправить `APPROVED`, что может при определенных условиях (не менее 3 ответственных за организацию тендера `submit_decision` отправили как `APPROVED`) перевести предложение в состояние `PUBLISHED`.

- Статус: `CREATED`.

- **Публикация**:

- Предложение становится доступно ответственным за организацию и автору.

- Предложение переходит в финальную стадию и оно является принятым решением для тендера. -> тендер автоматически закрывается, так как было найдено предложение, которое согласовали.

- Статус: `PUBLISHED`.

- **Отмена**:

- Виден только автору и ответственным за организацию.

- Состояние при котором предложение было либо отменено создателями, либо его отвергли ответственные за тендер. 

- Статус: `CANCELED`.

- **Редактирование**:

- Изменяются характеристики предложения.

- Меняются только два поля: `name`, `discription`. Если значение какого либо из полей не будет передано - оно автоматически останется неизменным.

- `Rollback` невозможен в двух случаях: когда статус предложения `CANCELED` или `PUBLISHED`. Потому что предложение уже было отменено по разным причинам, либо предложение было согласовано и нет смылса откатываться к более прошлым версиям.
- Увеличивается версия (то есть, если была 5 версия и мы хотим откатиться ко 2, актуальной станет 6 версия с параметрами 2 версии.

- **Согласование/отклонение**:

- Доступно только ответственным за организацию, связанной с тендером.

- Решение может быть принято любым ответственным (представителем организации от которого приходит тендер).

- Вот тут как раз 2 операции: `REJECTED` и `APPROVED` про их действия написано выше.

- При согласовании одного предложения, тендер автоматически закрывается.

## Неочевидные условия

1. Расширенный процесс согласования:

    - Если есть хотя бы одно решение reject, предложение отклоняется.

   - Для согласования предложения нужно получить решения больше или равно кворуму.
   
   - Кворум = min(3, количество ответственных за организацию).

3. Просмотр отзывов на прошлые предложения:

    - Ответственный за организацию может просмотреть отзывы на предложения автора, который создал предложение для его тендера.

5. Оставление отзывов на предложение:

    - Ответственный за организацию может оставить отзыв на предложение.

7. Добавить возможность отката по версии (Тендер и Предложение):

    - После отката, считается новой правкой с увеличением версии.

## Тестирование

### 1. Проверка доступности сервера
- **Эндпоинт:** GET /ping
- **Цель:** Убедиться, что сервер готов обрабатывать запросы.
- **Ожидаемый результат:** Статус код 200 и текст "ok".

```yaml
GET /api/ping

Response:

  200 OK

  Body: ok
```

### 2. Тестирование функциональности тендеров
#### Получение списка тендеров
- **Эндпоинт:** GET /tenders
- **Описание:** Возвращает список тендеров с возможностью фильтрации по типу услуг, если не будет передано тело serviceType - выведутся все тендеры.
- **Ожидаемый результат:** Статус код 200 и корректный список тендеров.
```yaml
GET /api/tenders?service_type="название типа сервиса"

Response:

  200 OK

  Body: [ 
    {
      ...
    }, 
    {
      ...
    }, 
    ... 
  ]
```

#### Создание нового тендера
- **Эндпоинт:** POST /tenders/new
- **Описание:** Создает новый тендер с заданными параметрами (нужно писать существующего пользователя который ответственен за организацию, но не является участником организации тендера куда пишется предложение).
- **Ожидаемый результат:** Статус код 200 и данные созданного тендера.

```yaml
POST /api/tenders/new

Request Body:

  {

    "name": "Тендер 1",

    "description": "Описание тендера",

    "serviceType": "Construction",

    "status": "CREATED",

    "organizationId": 1,

    "creatorUsername": "user1"

  }

Response:

  200 OK

  Body: 
  
  { 
    "id": 1, 
    "name": "Тендер 1", 
    "description": "Описание тендера",
    ...
  }
```

#### Получение тендеров пользователя
- **Эндпоинт:** GET /tenders/my
- **Описание:** Возвращает список тендеров текущего пользователя.
- **Ожидаемый результат:** Статус код 200 и список тендеров пользователя.

```yaml
GET /api/tenders/my?username=user1

Response:

  200 OK

  Body: [ {...}, {...}, ... ]  
```

#### Редактирование тендера
- **Эндпоинт:** PATCH /tenders/{tenderId}/edit
- **Описание:** Изменение параметров существующего тендера (могут изменять только члены организации где был создан тендер.). Версия будет увеличена.
- **Ожидаемый результат:** Статус код 200 и обновленные данные тендера.

```yaml
PATCH /api/tenders/1/edit?username=user1

Request Body:

  {

    "name": "Обновленный Тендер 1",

    "description": "Обновленное описание"

  }

Response:

  200 OK

  Body: 
  { 
    "id": 1, 
    "name": "Обновленный Тендер 1", 
    "description": "Обновленное описание",
    ...
  }  
```

#### Статус тендера
- **Эндпоинт:** GET /tenders/{tenderId}/status
- **Описание:** Статус существующего тендера 
- **Ожидаемый результат:** Статус код 200 и статус тендера.

```yaml
GET /api/tenders/1/status?username=user1

Response:

  200 OK

  Body: 
  "CREATED"
```

#### Изменить статус тендера
- **Эндпоинт:** PUT /tenders/{tenderId}/status
- **Описание:** Изменить статус существующего тендера (могут узнать только члены организации где был создан тендер.)
- **Ожидаемый результат:** Статус код 200 и тело тендера с измененным статусом.

```yaml
PUT /api/tenders/1/status?status=publish?username=user1

Response:

  200 OK

  Body: 
  {
  ...    
  }
```

#### Откат версии тендера
- **Эндпоинт:** PUT /tenders/{tenderId}/rollback/{version}
- **Описание:** Откатить параметры тендера к указанной версии. (могут узнать только члены организации где был создан тендер.)
- Если в текущей версии статус тендера `CLOSE`то мы не сможем откатиться к прошлой версии, так как предложение было закрыто
- **Ожидаемый результат:** Статус код 200 и данные тендера на указанной версии.

```yaml
PUT /api/tenders/1/rollback/2?username=user1

Response:

  200 OK

  Body: 
  { 
    "id": 1, 
    "name": "Тендер 1 версия 2", 
    ... 
  }
```

### 3. Тестирование функциональности предложений
#### Создание нового предложения
- **Эндпоинт:** POST /bids/new
- **Описание:** Создает новое предложение для существующего тендера.
- **Ожидаемый результат:** Статус код 200 и данные созданного предложения.
```yaml
POST /api/bids/new

Request Body:

  {
    "name": "Предложение 1",
    "description": "Описание предложения",
    "tenderId": 55,
    "author_type": "ORGANIZATION",
    "author_id": 1
  }

Response:

  200 OK

  Body: 
  { 
    "id": 1, 
    "name": "Предложение 1", 
    "description": "Описание предложения",
    ...
  }

POST /api/bids/new
Request Body:

  {
    "name": "Предложение 1",
    "description": "Описание предложения",
    "tenderId": 55,
    "author_type": "USER",
    "author_id": 1
  }

Response:

   200 OK

 Body:
    {
     "id": 1,
     "name": "Предложение 1",
     "description": "Описание предложения",
      ...
    }

```

#### Получение списка предложений для тендера
- **Эндпоинт:** GET /bids/{tenderId}/list
- **Описание:** Возвращает предложения, связанные с указанным тендером. (могут обратиться все те кто находятся в одной организации с тендером)
- **Ожидаемый результат:** Статус код 200 и список предложений для тендера.

```yaml
GET /api/bids/1/list?username=user1
Response:

  200 OK

  Body: [ {...}, {...}, ... ]
  
```

#### Редактирование предложения
- **Эндпоинт:** PATCH /bids/{bidId}/edit
- **Описание:** Редактирование существующего предложения. Может менять как член организации который находится в организации если мы выбрали `AuthorType: Organization`, а если выбрали `User`, то менять *может* только сам автор предложения.
- **Ожидаемый результат:** Статус код 200 и обновленные данные предложения.

```yaml
PATCH /api/bids/1/edit?username=user1

Request Body:

  {

    "name": "Обновленное Предложение 1",

    "description": "Обновленное описание"

  }

Response:

  200 OK

  Body: 
  { 
    "id": 1, 
    "name": "Обновленное Предложение 1", 
    "description": "Обновленное описание",
    ...,
  }
```

#### Откат версии предложения
- **Эндпоинт:** PUT /bids/{bidId}/rollback/{version}
- **Описание:** Откатить параметры предложения к указанной версии. (Из CANCELED и из PUBLISHED нельзя откатиться). Откатиться может только автор если AuthorType: User, или ответственные за организацию в которой создалось предложение в другом случае.
- **Ожидаемый результат:** Статус код 200 и данные предложения на указанной версии.

```yaml
PUT /api/bids/1/rollback/2/username=user1

Response:

  200 OK

  Body: 
  { 
    "id": 1, 
    "name": "Предложение 1 версия 2", 
    ...
  }
```

#### Статус предложения
- **Эндпоинт:** GET /bids/{bidId}/status
- **Описание:** Статус существующего предложения
- **Ожидаемый результат:** Статус код 200 и статус предложения.

```yaml
GET /api/bids/1/status?username=user1

Response:

  200 OK

  Body: 
  "CREATED"
```

#### Изменить статус предложения
- **Эндпоинт:** PUT /bids/{bidId}/status
- **Описание:** Изменить статус существующего предложения (могут узнать только автор если AuthorType: User, или ответственные за организацию в которой создалось предложение в другом случае.)
- **Ожидаемый результат:** Статус код 200 и тело предложения с измененным статусом.

```yaml
PUT /api/bids/1/status?status=PUBLISH?username=user1

Response:

  200 OK

  Body: 
  {
  ...    
  }
```

#### Изменить статус предложения (REJECTED/APPROVE)
- **Эндпоинт:** PUT bids/{bidId}/submit_decision
- **Описание:** Изменить статус существующего предложения (могут узнать только ответственные за организацию в которой создался тендер.)
- **Ожидаемый результат:** Статус код 200 и тело предложения с измененным статусом решения.

```yaml
PUT /api/bids/1/submit_decision?decision=Approved&username=user1

Response:

  200 OK

  Body: 
  {
  ...    
  }
```

### 4. Тестирование функциональности отзывов
#### Просмотр отзывов на прошлые предложения
- **Эндпоинт:** GET /bids/{tenderId}/reviews
- **Описание:** Ответственный за организацию может посмотреть прошлые отзывы на предложения автора, который создал предложение для его тендера.
- **Ожидаемый результат:** Статус код 200 и список отзывов на предложения указанного автора.

```yaml
GET /api/bids/1/reviews?authorUsername=user2&organizationId=1

Response:

  200 OK

  Body: [ {...}, {...}, ... ]
```

### Написание отзыва на предложение
- **Эндпоинт:** GET /bids//{bidId}/feedback
- **Описание:** Ответственный за организацию может посмотреть прошлые отзывы на предложения автора, который создал предложение для его тендера.
- **Ожидаемый результат:** Статус код 200 и список отзывов на предложения указанного автора.

```yaml
PUT /api/bids/2/feedback?bidFeedback=Все хорошо&username=user1

Response:

  200 OK

  Body: {
     ID: 1, 
     BidId: 2,
     FeedBack: Все хорошо
     ...
}
```

# Структура проекта
Весь проект разбит на файлы.
### `cmd/server/`
По этому пути расположен файл `main.go`, который содержит в себе все [ручки] и все самое главное для правильной работы проекта.

### `config/`
По этому пути расположен файл `config.go`, в котором находится функция, запускающая все перенные из окружение, тем самым вызывая конфигурацию.
 
### `db/migrations/`
По этому пути расположен файл `tables_base.go`, в котором представлены таблицы для миграции (даны по условию `ТЗ`).

### `docs/`
По этому пути расположены файлы, которые отвечают за `Swagger`, для лучшего представления микросервиса.
### `handlers/`
По этому пути расположены файлы, которые отвечают за основную работу приложения (ручки).
- `bids.go` отвечает за описание всех действия, связанных с Предложениями.
- `ping.go` отвечает за базовую операцию при тестировании предложения `/api/ping`
- `tenders.go` отвечает за описание всех действий, связанных с Тендерами.

### `middleware/` 
По этому пути расположен файл, который приписывает к каждому запросу `"Content-Type", "application/json"`, для представления данных в `json'e`.

### `models/`
По этому пути расположены все модели баз данных, которые созданы для миграции. 

### `utils/`
По этому пути расположены файлы с быстрым переводом  `json'a` в читаемый вид (`JSONFormat.go`) и `database.go`. Этот файл отвечает за автомиграцию моделей, (которые расположены выше), с помощью фреймворка `gorm`.
### `validators/`
По этому пути расположен файл `Validate.go`, который отвечает за проверку при создании тендера (правильный ввод данных, правильная обработка их).


# Параметры файла .env:

- SERVER_ADDRESS=0.0.0.0:8080
- POSTGRES_HOST=localhost
- POSTGRES_PORT=5432
- POSTGRES_USERNAME=postgres
- POSTGRES_PASSWORD=123456
- POSTGRES_DATABASE=tendersdb
- POSTGRES_JDBC_URL=jdbc:postgresql://localhost:5432/tendersdb
- POSTGRES_CONN=postgres://postgres:123456@localhost:5432/tendersdb

# Swagger
- Локально показывает все верно, на всякий случай путь к `main` -> `cmd/server/main.go`.
- Для взаимодействия со Swagger'ом необходимо прописать `swag init -g (путь к main.go)`
- Для запуска используйте http://localhost:8080/swagger/index.html


# Версия приложения
Версия данного микросервиса - 1.0v. Все функции работают исправно, все ошибки отлавливаются.
 







